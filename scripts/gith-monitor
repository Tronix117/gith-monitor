#!/usr/bin/env coffee

global.extend = (target)->
  target[name] = arg[name] for name in Object.keys arg for arg in arguments
  target

githMonitorPath = null
GithMonitor = (try require githMonitorPath = path.join realdir, '..', 'index') or require githMonitorPath = 'gith-monitor'

init = require githMonitorPath + '/node_modules/init'
path = require 'path'
fs = require 'fs'

realdir = path.dirname(fs.realpathSync(__filename))

global.config = extend (try require path.join realdir, '..', 'config') or {}, (try require '/etc/gith-deploy') or {}, (try require '~/.gith-deploy') or {}

unless GithMonitor
  console.error 'Can\'t find gith-monitor, make sure you have done `npm install -g gith-monitor`.' 
else
  init.simple 
    pidfile : config.pidfile
    logfile : config.logfile
    command : process.argv[2]
    run     : ()-> new GithMonitor config